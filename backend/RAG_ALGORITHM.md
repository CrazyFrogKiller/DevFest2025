# RAG System - –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

## üìã –ü–æ–ª–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å

### 1Ô∏è‚É£ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞ (POST /api/documents/upload)

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ñ–∞–π–ª (txt, pdf, docx, md)
    ‚Üì
API —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∞–π–ª –Ω–∞ –¥–∏—Å–∫
    ‚Üì
IngestionService.create_document()
    ‚îú‚îÄ –°–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å—å –≤ —Ç–∞–±–ª–∏—Ü–µ `documents`
    ‚îú‚îÄ FileParser.parse_file() ‚Äî —á–∏—Ç–∞–µ—Ç —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞
    ‚îú‚îÄ ChunkingService.chunk_document() ‚Äî —Ä–∞–∑–±–∏–≤–∞–µ—Ç –Ω–∞ —á–∞–Ω–∫–∏
    ‚îÇ   ‚îú‚îÄ TextProcessor.smart_chunk_text() ‚Äî —É–º–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –ø–æ —Å–º—ã—Å–ª—É
    ‚îÇ   ‚îú‚îÄ –°–æ–∑–¥–∞—ë—Ç –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ `chunks` —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
    ‚îÇ   ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
    ‚îî‚îÄ EmbeddingService.embed_chunks() ‚Äî —Å–æ–∑–¥–∞—ë—Ç –≤–µ–∫—Ç–æ—Ä–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è
        ‚îú‚îÄ –î–ª—è –∫–∞–∂–¥–æ–≥–æ —á–∞–Ω–∫–∞ –≤—ã–∑—ã–≤–∞–µ—Ç Google Gemini API
        ‚îú‚îÄ –ü–æ–ª—É—á–∞–µ—Ç –≤–µ–∫—Ç–æ—Ä —Ä–∞–∑–º–µ—Ä 768
        ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –∫–æ–ª–æ–Ω–∫—É `embedding` —Ç–∞–±–ª–∏—Ü—ã `chunks`
        ‚îî‚îÄ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
    ‚úÖ –ì–æ—Ç–æ–≤–æ!
```

### 2Ô∏è‚É£ –ü–æ–∏—Å–∫ –ø–æ –∑–∞–ø—Ä–æ—Å—É (POST /api/queries/ask)

```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–µ–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å: "–ß—Ç–æ —Ç–∞–∫–æ–µ RAG?"
    ‚Üì
RetrievalService.retrieve_chunks()
    ‚îú‚îÄ EmbeddingService.embed_text() ‚Äî —Å–æ–∑–¥–∞—ë—Ç –≤–µ–∫—Ç–æ—Ä –∑–∞–ø—Ä–æ—Å–∞
    ‚îÇ   ‚îî‚îÄ Calls Google Gemini API ‚Üí –≤–µ–∫—Ç–æ—Ä 768D
    ‚îú‚îÄ SQL –∑–∞–ø—Ä–æ—Å –∫ –ë–î —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º <-> (cosine distance)
    ‚îÇ   ‚îî‚îÄ SELECT * FROM chunks ORDER BY embedding <-> query_vector LIMIT 5
    ‚îú‚îÄ PostgreSQL pgvector –Ω–∞—Ö–æ–¥–∏—Ç 5 —Å–∞–º—ã—Ö –ø–æ—Ö–æ–∂–∏—Ö —á–∞–Ω–∫–æ–≤
    ‚îî‚îÄ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç (chunk, similarity_score) –ø–∞—Ä—ã
    ‚Üì
SynthesisService.generate_answer()
    ‚îú‚îÄ –ë–µ—Ä—ë—Ç —Ç–æ–ø-5 —á–∞–Ω–∫–æ–≤ —Å –Ω–∞–∏–±–æ–ª—å—à–µ–π —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é
    ‚îú‚îÄ –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM
    ‚îî‚îÄ Calls Google Gemini API ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ —Ä—É—Å—Å–∫–æ–º
    ‚Üì
API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
    ‚úÖ –ì–æ—Ç–æ–≤–æ!
```

## üóÑÔ∏è –¢–∞–±–ª–∏—Ü—ã –ë–î

### documents

```
id (UUID)          - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞
filename (VARCHAR) - –∏–º—è —Ñ–∞–π–ª–∞
title (VARCHAR)    - –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
file_size (INT)    - —Ä–∞–∑–º–µ—Ä –≤ –±–∞–π—Ç–∞—Ö
uploaded_at (TIMESTAMP) - –∫–æ–≥–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω
doc_metadata (JSONB)    - –¥–æ–ø. –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ç–µ–≥–∏, –∫–∞—Ç–µ–≥–æ—Ä–∏—è –∏ —Ç.–¥.)
```

### chunks

```
id (UUID)                  - –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞–Ω–∫–∞
document_id (UUID FK)      - —Å—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç
content (TEXT)             - —Ç–µ–∫—Å—Ç —á–∞–Ω–∫–∞ (0.5-2KB –æ–±—ã—á–Ω–æ)
chunk_index (INT)          - –Ω–æ–º–µ—Ä —á–∞–Ω–∫–∞ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
embedding (vector(768))   - –≤–µ–∫—Ç–æ—Ä —ç–º–±–µ–¥–¥–∏–Ω–≥–∞ (—á–∏—Å–ª–∞ -1..1)
chunk_metadata (JSONB)     - {start_char, end_char, document_filename, category}
created_at (TIMESTAMP)     - –∫–æ–≥–¥–∞ —Å–æ–∑–¥–∞–Ω
```

## üîç –ü–æ–∏—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–ª–∞–≥–æ–¥–∞—Ä—è

### pgvector —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ

- –•—Ä–∞–Ω–∏—Ç –≤–µ–∫—Ç–æ—Ä—ã –∫–∞–∫ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ç–∏–ø `vector(768)`
- –û–ø–µ—Ä–∞—Ç–æ—Ä `<->` –≤—ã—á–∏—Å–ª—è–µ—Ç –∫–æ—Å–∏–Ω—É—Å–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ (cosine distance)
- –ò–Ω–¥–µ–∫—Å IVFFLAT –ø–æ–∑–≤–æ–ª—è–µ—Ç –±—ã—Å—Ç—Ä–æ –∏—Å–∫–∞—Ç—å –ø–æ—Ö–æ–∂–∏–µ –≤–µ–∫—Ç–æ—Ä—ã

### Google Gemini API

- **Embedding**: `models/gemini-embedding-001` (768D)
- **Chat**: `models/gemini-pro` (–¥–ª—è –æ—Ç–≤–µ—Ç–æ–≤)

## ‚ö†Ô∏è –ü–æ—á–µ–º—É –Ω–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤?

–ü—Ä–∏—á–∏–Ω—ã –≤ –ø–æ—Ä—è–¥–∫–µ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏:

1. **–ù–µ—Ç —á–∞–Ω–∫–æ–≤ –≤ –ë–î** ‚Üê –ò–º–µ–Ω–Ω–æ –≤–∞—à —Å–ª—É—á–∞–π!

   - –ó–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –Ω–µ –±—ã–ª —Ä–∞–∑–±–∏—Ç –Ω–∞ —á–∞–Ω–∫–∏
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: `SELECT COUNT(*) FROM chunks`

2. **–ù–µ—Ç —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤**

   - –ß–∞–Ω–∫–∏ –µ—Å—Ç—å, –Ω–æ embedding = NULL
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: `SELECT COUNT(*) FROM chunks WHERE embedding IS NOT NULL`

3. **–ö–≤–æ—Ç–∞ Google API –∏—Å—á–µ—Ä–ø–∞–Ω–∞**

   - –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω: 100 embedding –∑–∞–ø—Ä–æ—Å–æ–≤/–¥–µ–Ω—å
   - –†–µ—à–µ–Ω–∏–µ: –ø–æ–¥–æ–∂–¥–∞—Ç—å –∏–ª–∏ –≤–∫–ª—é—á–∏—Ç—å –ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω

4. **–°–ª–∏—à–∫–æ–º –≤—ã—Å–æ–∫–∏–π threshold (–ø–æ—Ä–æ–≥ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏)**
   - –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: 0.5 (–Ω—É–∂–Ω–∞ —Ö–æ—Ç—è –±—ã 50% –ø–æ—Ö–æ–∂–µ—Å—Ç—å)
   - –ï—Å–ª–∏ –≤—Å–µ —á–∞–Ω–∫–∏ –º–µ–Ω–µ–µ –ø–æ—Ö–æ–∂–∏ ‚Üí –ø—É—Å—Ç–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

## ‚úÖ –ß—Ç–æ –Ω–∞–¥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

```bash
# 1. –ï—Å—Ç—å –ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã?
SELECT COUNT(*) FROM documents;

# 2. –ï—Å—Ç—å –ª–∏ —á–∞–Ω–∫–∏?
SELECT COUNT(*) FROM chunks;

# 3. –°–∫–æ–ª—å–∫–æ —á–∞–Ω–∫–æ–≤ —Å —ç–º–±–µ–¥–¥–∏–Ω–≥–∞–º–∏?
SELECT COUNT(*) FROM chunks WHERE embedding IS NOT NULL;

# 4. –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–∏–º–µ—Ä—ã —á–∞–Ω–∫–æ–≤
SELECT id, content, embedding FROM chunks LIMIT 3;
```

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
# 1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
uv run python -m uvicorn app.main:app --reload --host 127.0.0.1 --port 8001

# 2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç
curl -F "file=@document.txt" "http://127.0.0.1:8001/api/documents/upload?title=MyDoc"

# 3. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ ‚Äî –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Ä–æ–¥–µ:
#    ‚úÖ Document created: 12c48ac2-...
#    ‚úÖ Created 25 chunks for document 12c48ac2-...
#    ‚úÖ Generated embeddings for 25 chunks

# 4. –î–µ–ª–∞–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã
curl -X POST "http://127.0.0.1:8001/api/queries/ask" \
  -H "Content-Type: application/json" \
  -d '{"query": "Your question here", "top_k": 5}'
```
